---
title: "Initial Analysis - grand center NDVI + L1 covariates"
output: html_notebook
---

```{r setup, echo=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(lme4)
library(multilevel)
library(sjPlot)
library(sjmisc)
library(broom)

df <- readRDS("../data/full_mlm_datset.rds")
df_na <- df %>% filter(!is.na(gndctr_MedHHinc000)& !is.na(gndctr_disad))
```
So far I have fit models with the raw NDVI and the grand centered NDVI. These have been with random intercepts and then with random intercepts and slopes for the NDVI measure.

```{r}
mod_2a <- lmer(CRMCYTOTC ~ gndctr_ndvi_cbg_adj + (1|city_st), data = df_na)
mod_2b <- lmer(CRMCYPERC ~ gndctr_ndvi_cbg_adj + (1|city_st), data = df_na)
mod_2c <- lmer(CRMCYPROC ~ gndctr_ndvi_cbg_adj + (1|city_st), data = df_na)
mod_3a <- lmer(CRMCYTOTC ~ gndctr_ndvi_cbg_adj + (gndctr_ndvi_cbg_adj|city_st), data = df_na)
mod_3b <- lmer(CRMCYPERC ~ gndctr_ndvi_cbg_adj + (gndctr_ndvi_cbg_adj|city_st), data = df_na)
mod_3c <- lmer(CRMCYPROC ~ gndctr_ndvi_cbg_adj + (gndctr_ndvi_cbg_adj|city_st), data = df_na)
```
Now let's add the level 1 covariates and see how things change. Only the violent and property crimes will be used. First with only random intercepts. 
```{r}
mod_4b <- lmer(CRMCYPERC ~ gndctr_ndvi_cbg_adj + gndctr_MedHHinc000 + gndctr_disad + gndctr_diver + gndctr_U18 + gndctr_logpopden + (1|city_st), data = df_na)
mod_4c <- lmer(CRMCYPROC ~ gndctr_ndvi_cbg_adj + gndctr_MedHHinc000 + gndctr_disad + gndctr_diver + gndctr_U18 + gndctr_logpopden + (1|city_st), data = df_na)

summary(mod_4b)
summary(mod_4c)
```
Do these models have a better fit compared the models without the covariates?
```{r}
glance(mod_2b)
glance(mod_4b)
anova(mod_2b, mod_4b)
anova(mod_2c, mod_4c)
```
and then add the random slope for NDVI.
```{r}
mod_5b <- lmer(CRMCYPERC ~ gndctr_ndvi_cbg_adj + gndctr_MedHHinc000 + gndctr_disad + gndctr_diver + gndctr_U18 + gndctr_logpopden + (gndctr_ndvi_cbg_adj|city_st), data = df_na)
mod_5c <- lmer(CRMCYPROC ~ gndctr_ndvi_cbg_adj + gndctr_MedHHinc000 + gndctr_disad + gndctr_diver + gndctr_U18 + gndctr_logpopden + (gndctr_ndvi_cbg_adj|city_st), data = df_na)

summary(mod_5b)
summary(mod_5c)
```
Compare models.
```{r}
anova(mod_3b, mod_5b)
anova(mod_4b, mod_5b)
anova(mod_3c, mod_5c)
anova(mod_4c, mod_5c)

```
Check the covariance structure
```{r}
VarCorr(mod_5b)$city_st
# these values are the 'error' terms that are added to the estimates. The estimates are the average and these random effects are the adjustments.
myrandomeff <- ranef(mod_5b, condVar = TRUE)



base::mean(myrandomeff$city_st$gndctr_ndvi_cbg_adj)
myrandomeff$city_st %>% ggplot(aes(`(Intercept)`, gndctr_ndvi_cbg_adj)) + geom_point() + ggtitle("random effects (adjustments for cities) - Violent Crime")
modcoef <- coef(mod_5b)$city_st
modcoef %>% ggplot(aes(`(Intercept)`, gndctr_ndvi_cbg_adj)) + geom_point() + ggtitle("Intercept and slope estimates - Violent Crime")
```

The intercept variance has increased with the varying slopes, let's look at a plot to see what is going on.
```{r}
ricoeff <- coef(mod_4b)$city_st
df_na %>% ggplot(aes(gndctr_ndvi_cbg_adj,CRMCYPERC)) + geom_point(alpha=0) +geom_abline(data = ricoeff, aes(intercept=`(Intercept)`, slope=gndctr_ndvi_cbg_adj), alpha = 0.2) + labs(title = "Random Intercepts")

df_na %>% ggplot(aes(gndctr_ndvi_cbg_adj,CRMCYPERC)) + geom_point(alpha=0) +geom_abline(data = modcoef, aes(intercept=`(Intercept)`, slope=gndctr_ndvi_cbg_adj), alpha = 0.2) + labs(title = "Random Intercepts & Slopes")

```

